# =====================================================================
# Online Saathi - Docker Compose Configuration
# Frontend + Backend एकसाथ (Single Container)
# Works with: Railway, Render, Local Development
# =====================================================================

version: "3.8"

services:
  # ===========================================
  # Main Application (Frontend + Backend)
  # ===========================================
  app:
    container_name: onlinesaathi-app
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORT:-3080}:${PORT:-3080}"
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=${PORT:-3080}
      - MONGO_URI=mongodb://mongodb:27017/OnlineSaathi
      - JWT_SECRET=${JWT_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - CREDS_KEY=${CREDS_KEY}
      - CREDS_IV=${CREDS_IV}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_KEY=${GOOGLE_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN}
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - ./images:/app/client/public/images
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-3080}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - saathi-network

  # ===========================================
  # MongoDB Database
  # ===========================================
  mongodb:
    container_name: onlinesaathi-mongodb
    image: mongo:7.0
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    command: mongod --noauth
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - saathi-network

# ===========================================
# Volumes
# ===========================================
volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

# ===========================================
# Networks
# ===========================================
networks:
  saathi-network:
    driver: bridge
